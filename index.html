<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SISTEMA TWINS | Warehouse Pro</title>
    <style>
        :root {
            --bg: #0f172a; --card: #1e293b; --primary: #38bdf8; --primary-dark: #0284c7;
            --success: #10b981; --danger: #f43f5e; --warning: #fbbf24; --text: #f8fafc; 
            --text-dim: #94a3b8; --border: #334155;
        }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; margin: 0; -webkit-tap-highlight-color: transparent; }
        
        .page { display: none; padding: 15px; animation: fadeIn 0.3s ease; }
        .active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .card { background: var(--card); border-radius: 12px; border: 1px solid var(--border); padding: 15px; margin-bottom: 12px; }
        
        /* Botones Optimizados */
        .btn { width: 100%; padding: 14px; border-radius: 10px; border: none; font-size: 14px; font-weight: 700; cursor: pointer; margin-top: 8px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-main { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; }
        .btn-save { background: var(--success); color: white; }
        .btn-outline { background: transparent; border: 1.5px solid var(--border); color: var(--text); }
        
        /* Selects y Inputs Compactos */
        input, select { 
            width: 100%; padding: 12px; margin: 6px 0; border-radius: 10px; 
            border: 1px solid var(--border); background: var(--bg); color: var(--text); 
            font-size: 15px; box-sizing: border-box; outline: none;
        }
        
        /* Ajuste espec√≠fico para que la lista no sea gigante */
        select { font-size: 14px; height: 45px; }

        .stat-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 10px; }
        .stat-box { 
            background: rgba(56, 189, 248, 0.1); padding: 10px; border-radius: 10px; 
            border: 1px solid rgba(56, 189, 248, 0.2); text-align: center; 
        }
        .stat-box small { font-size: 10px; color: var(--text-dim); text-transform: uppercase; display: block; }
        .stat-box b { font-size: 18px; color: var(--primary); }

        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border); }
        .history-card { border-left: 4px solid var(--primary); font-size: 13px; }
    </style>
</head>
<body data-theme="dark">

    <div id="p1" class="page active">
        <div style="text-align:center; margin-top: 60px;">
            <h1 style="font-size: 28px;">TWINS <span style="color:var(--primary)">PRO</span></h1>
            <p style="color:var(--text-dim); font-size: 14px;">Gesti√≥n de Despachos</p>
        </div>
        <div style="margin-top: 40px;">
            <button class="btn btn-outline" onclick="login('TAJHO')">ENTRAR COMO TAJHO</button>
            <button class="btn btn-outline" onclick="login('FRANCESCO')">ENTRAR COMO FRANCESCO</button>
            <button class="btn btn-outline" onclick="login('OSCAR')">ENTRAR COMO OSCAR</button>
        </div>
    </div>

    <div id="p2" class="page">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <b id="display-user" style="color:var(--primary); font-size:14px;"></b>
            <button onclick="location.reload()" style="background:var(--danger); color:white; border:none; padding:6px 12px; border-radius:8px; font-size:12px;">SALIR</button>
        </div>

        <div id="edit-indicator" style="display:none; background:var(--warning); color:black; padding:6px; border-radius:8px; margin-bottom:10px; text-align:center; font-weight:bold; font-size:12px;">MODO EDICI√ìN</div>

        <div class="card" style="text-align:center; padding: 10px;">
            <small style="color:var(--text-dim); font-size:11px;">TOTAL CAJAS</small>
            <div id="total-vivo" style="font-size:32px; font-weight:800; color:var(--primary)">0</div>
        </div>

        <div class="card">
            <input type="text" id="cli" placeholder="Cliente / Destino">
            <input type="number" id="can" placeholder="Cant. Cajas" inputmode="numeric">
            <button class="btn btn-main" onclick="addDestino()">+ A√ëADIR DESTINO</button>
        </div>

        <div id="area-envio" style="display:none;">
            <div class="card" id="lista-actual" style="font-size:14px;"></div>
            <div class="card">
                <select id="cho">
                    <option value="">Chofer...</option>
                    <option value="LUIS H.">LUIS H.</option>
                    <option value="ROMARIO">ROMARIO</option>
                    <option value="CESAR C.">CESAR C.</option>
                    <option value="WALDIR">WALDIR</option>
                    <option value="MARCELO">MARCELO</option>
                    <option value="TAJHO">TAJHO</option>
                </select>
                <select id="aux">
                    <option value="">Auxiliar...</option>
                    <option value="CRISTOPHER">CRISTOPHER</option>
                    <option value="LUIS PLACIDO">LUIS PLACIDO</option>
                    <option value="RODOLFO">RODOLFO</option>
                    <option value="ELIO">ELIO</option>
                    <option value="PERCY">PERCY</option>
                    <option value="MARTIN">MARTIN</option>
                    <option value="JOFER">JOFER</option>
                </select>
                <select id="pla"><option value="">Placa...</option><option value="BUL742">BUL742</option><option value="BPN104">BPN104</option></select>
                
                <button class="btn btn-save" onclick="procesar(true)">üíæ GUARDAR Y ENVIAR WA</button>
                <button class="btn btn-outline" style="border-color:var(--success); color:var(--success);" onclick="procesar(false)">üìå SOLO GUARDAR</button>
                <button class="btn" style="color:var(--danger); font-size:11px;" onclick="cancelar()">CANCELAR RUTA</button>
            </div>
        </div>
        <button class="btn btn-outline" style="border-color:var(--primary); color:var(--primary);" onclick="showHistory()">üìä REPORTE MENSUAL</button>
    </div>

    <div id="p3" class="page">
        <button class="btn btn-outline" style="width:auto; margin-bottom:15px; padding: 10px;" onclick="switchPage('p3', 'p2')">‚Üê VOLVER</button>
        
        <div class="card" style="padding:10px;">
            <select id="filter-month" onchange="renderHistory()" style="margin:0;">
                <option value="0">Enero</option><option value="1">Febrero</option><option value="2">Marzo</option>
                <option value="3">Abril</option><option value="4">Mayo</option><option value="5">Junio</option>
                <option value="6">Julio</option><option value="7">Agosto</option><option value="8">Septiembre</option>
                <option value="9">Octubre</option><option value="10">Noviembre</option><option value="11">Diciembre</option>
            </select>
        </div>

        <div id="stats-container" class="stat-grid"></div>

        <div id="history-list"></div>
    </div>

    <script>
        let user = "", route = [], editId = null;
        let db = JSON.parse(localStorage.getItem('twins_v31')) || [];

        document.getElementById('filter-month').value = new Date().getMonth();

        function switchPage(h, s) { document.getElementById(h).classList.remove('active'); document.getElementById(s).classList.add('active'); window.scrollTo(0,0); }
        function login(n) { user = n; document.getElementById('display-user').innerText = "OPERARIO: " + n; switchPage('p1', 'p2'); }
        
        function addDestino() {
            const c = document.getElementById('cli').value.toUpperCase().trim(), q = parseInt(document.getElementById('can').value);
            if(!c || isNaN(q)) return;
            route.push({id: Date.now(), c, q});
            renderRoute();
            document.getElementById('cli').value = ""; document.getElementById('can').value = "";
        }

        function renderRoute() {
            const l = document.getElementById('lista-actual'), t = document.getElementById('total-vivo');
            l.innerHTML = ""; let s = 0;
            route.forEach(i => { s += i.q; l.innerHTML += `<div class="item-row"><span><b>${i.c}</b> (${i.q})</span><button onclick="delItem(${i.id})" style="background:var(--danger); color:white; border:none; border-radius:5px; padding:5px 8px;">‚úï</button></div>`; });
            t.innerText = s; document.getElementById('area-envio').style.display = route.length > 0 ? 'block' : 'none';
        }

        function delItem(id) { route = route.filter(i => i.id !== id); renderRoute(); }
        function cancelar() { route = []; editId = null; document.getElementById('edit-indicator').style.display="none"; renderRoute(); }

        function procesar(wa) {
            const ch = document.getElementById('cho').value, pl = document.getElementById('pla').value, ax = document.getElementById('aux').value;
            if(!ch || !pl || !ax) return alert("Faltan datos (Chofer/Auxiliar/Placa)");
            
            const reg = { 
                id: editId || Date.now(), fecha: editId ? db.find(r => r.id === editId).fecha : new Date().toISOString(), 
                operario: user, chofer: ch, placa: pl, auxiliar: ax, destinos: [...route], 
                total: route.reduce((a,b)=>a+b.q, 0) 
            };

            if(editId) db = db.map(r => r.id === editId ? reg : r); else db.push(reg);
            localStorage.setItem('twins_v31', JSON.stringify(db));

            if(wa) {
                let msg = `*REPORTE TWINS*\nüë§ Op: ${user}\nüöö Ch: ${ch}\nüöõ Pl: ${pl}\nüèÉ Aux: ${ax}\n----------------\n`;
                route.forEach(i => msg += `‚Ä¢ ${i.c}: ${i.q} CJ\n`);
                msg += `----------------\nüì¶ TOTAL: ${reg.total} CAJAS`;
                window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`);
            }
            cancelar(); alert("Ruta Guardada");
        }

        function showHistory() { renderHistory(); switchPage('p2', 'p3'); }

        function renderHistory() {
            const list = document.getElementById('history-list'), m = parseInt(document.getElementById('filter-month').value);
            const statsCont = document.getElementById('stats-container');
            let choferesStats = {}; list.innerHTML = "";
            
            db.slice().reverse().forEach(r => {
                const d = new Date(r.fecha);
                if(d.getMonth() === m) {
                    choferesStats[r.chofer] = (choferesStats[r.chofer] || 0) + r.total;
                    list.innerHTML += `<div class="card history-card">
                        <div style="display:flex; justify-content:space-between; font-weight:bold; color:var(--primary); margin-bottom:5px;">
                            <span>${d.toLocaleDateString()}</span><span>${r.total} CJ</span>
                        </div>
                        <b>${r.chofer}</b> | ${r.placa}<br>
                        <small style="color:var(--text-dim)">Aux: ${r.auxiliar}</small><br>
                        <button class="btn btn-outline" style="font-size:11px; padding:6px; margin-top:8px;" onclick="editH(${r.id})">‚úèÔ∏è EDITAR</button>
                    </div>`;
                }
            });

            statsCont.innerHTML = "";
            for (let c in choferesStats) {
                statsCont.innerHTML += `<div class="stat-box"><small>${c}</small><b>${choferesStats[c]}</b></div>`;
            }
        }

        function editH(id) {
            const r = db.find(x => x.id === id);
            editId = id; route = [...r.destinos];
            document.getElementById('cho').value = r.chofer;
            document.getElementById('pla').value = r.placa;
            document.getElementById('aux').value = r.auxiliar;
            document.getElementById('edit-indicator').style.display = "block";
            renderRoute(); switchPage('p3', 'p2');
        }
    </script>
</body>
</html>
