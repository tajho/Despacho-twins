<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SISTEMA TWINS | Reporte Mensual Pro</title>
    <style>
        :root {
            --bg: #0f172a; --card: #1e293b; --primary: #38bdf8; --primary-dark: #0284c7;
            --success: #10b981; --danger: #f43f5e; --warning: #fbbf24; --text: #f8fafc; 
            --text-dim: #94a3b8; --border: #334155;
        }
        [data-theme="light"] {
            --bg: #f1f5f9; --card: #ffffff; --primary: #0284c7; --primary-dark: #0c4a6e;
            --success: #059669; --danger: #e11d48; --warning: #d97706; --text: #0f172a; 
            --text-dim: #64748b; --border: #e2e8f0;
        }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; margin: 0; transition: 0.3s; }
        .page { display: none; padding: 20px; animation: slideUp 0.3s ease-out; }
        .active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .card { background: var(--card); border-radius: 16px; border: 1px solid var(--border); padding: 18px; margin-bottom: 15px; }
        .btn { width: 100%; padding: 16px; border-radius: 12px; border: none; font-size: 15px; font-weight: 700; cursor: pointer; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-main { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; }
        .btn-save { background: var(--success); color: white; }
        .btn-outline { background: transparent; border: 2px solid var(--border); color: var(--text); }
        input, select { width: 100%; padding: 14px; margin: 10px 0; border-radius: 12px; border: 2px solid var(--border); background: var(--bg); color: var(--text); font-size: 16px; box-sizing: border-box; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
        .stat-box { background: var(--card); padding: 12px; border-radius: 12px; border-bottom: 3px solid var(--primary); text-align: center; }
        .stat-box b { font-size: 22px; color: var(--primary); display: block; }
        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border); }
    </style>
</head>
<body data-theme="dark">

    <div id="p1" class="page active">
        <div style="text-align:center; margin-top: 60px;">
            <h1 style="font-size: 32px;">SISTEMA <span style="color:var(--primary)">TWINS</span></h1>
            <p style="color:var(--text-dim)">Control de Despachos V29</p>
        </div>
        <div style="margin-top: 50px;">
            <button class="btn btn-outline" onclick="login('TAJHO')">ENTRAR COMO TAJHO</button>
            <button class="btn btn-outline" onclick="login('FRANCESCO')">ENTRAR COMO FRANCESCO</button>
            <button class="btn btn-outline" onclick="login('OSCAR')">ENTRAR COMO OSCAR</button>
        </div>
    </div>

    <div id="p2" class="page">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <b id="display-user" style="color:var(--primary)"></b>
            <button onclick="location.reload()" style="background:var(--danger); color:white; border:none; padding:8px; border-radius:8px;">SALIR</button>
        </div>

        <div id="edit-indicator" style="display:none; background:var(--warning); color:black; padding:8px; border-radius:8px; margin:10px 0; text-align:center; font-weight:bold;">MODO EDICI√ìN</div>

        <div class="card" style="text-align:center; margin-top:15px;">
            <small style="color:var(--text-dim)">CAJAS ACTUALES</small>
            <div id="total-vivo" style="font-size:40px; font-weight:800; color:var(--primary)">0</div>
        </div>

        <div class="card">
            <input type="text" id="cli" placeholder="Cliente / Destino">
            <input type="number" id="can" placeholder="Cantidad de Cajas" inputmode="numeric">
            <button class="btn btn-main" onclick="addDestino()">+ A√ëADIR DESTINO</button>
        </div>

        <div id="area-envio" style="display:none;">
            <div class="card" id="lista-actual"></div>
            <div class="card">
                <select id="cho"><option value="">Chofer...</option><option value="ROMARIO">ROMARIO</option><option value="CESAR">CESAR</option></select>
                <select id="pla"><option value="">Placa...</option><option value="BUL742">BUL742</option><option value="BPN104">BPN104</option></select>
                <select id="aux"><option value="">Auxiliar...</option><option value="TAJHO">TAJHO</option><option value="CRISTOPHER">CRISTOPHER</option></select>
                <button class="btn btn-save" onclick="procesar(true)">üíæ GUARDAR Y ENVIAR WA</button>
                <button class="btn btn-outline" onclick="procesar(false)">üìå SOLO GUARDAR</button>
                <button class="btn" style="color:var(--danger); font-size:12px;" onclick="cancelar()">CANCELAR</button>
            </div>
        </div>
        <button class="btn btn-outline" onclick="showHistory()">üìä REPORTE MENSUAL</button>
    </div>

    <div id="p3" class="page">
        <button class="btn btn-outline" style="width:auto;" onclick="switchPage('p3', 'p2')">‚Üê VOLVER</button>
        
        <div class="card">
            <label>Filtrar por Mes:</label>
            <select id="filter-month" onchange="renderHistory()">
                <option value="0">Enero</option><option value="1">Febrero</option><option value="2">Marzo</option>
                <option value="3">Abril</option><option value="4">Mayo</option><option value="5">Junio</option>
                <option value="6">Julio</option><option value="7">Agosto</option><option value="8">Septiembre</option>
                <option value="9">Octubre</option><option value="10">Noviembre</option><option value="11">Diciembre</option>
            </select>
        </div>

        <div class="stat-grid">
            <div class="stat-box"><small>ROMARIO</small><b id="st-rom">0</b></div>
            <div class="stat-box"><small>CESAR</small><b id="st-ces">0</b></div>
        </div>

        <div id="history-list"></div>
    </div>

    <script>
        let user = "", route = [], editId = null;
        let db = JSON.parse(localStorage.getItem('twins_v29')) || [];

        // Iniciar mes actual en el filtro
        document.getElementById('filter-month').value = new Date().getMonth();

        function switchPage(h, s) { document.getElementById(h).classList.remove('active'); document.getElementById(s).classList.add('active'); }
        function login(n) { user = n; document.getElementById('display-user').innerText = "üë§ "+n; switchPage('p1', 'p2'); }
        
        function addDestino() {
            const c = document.getElementById('cli').value.toUpperCase(), q = parseInt(document.getElementById('can').value);
            if(!c || isNaN(q)) return;
            route.push({id: Date.now(), c, q});
            renderRoute();
            document.getElementById('cli').value = ""; document.getElementById('can').value = "";
        }

        function renderRoute() {
            const l = document.getElementById('lista-actual'), t = document.getElementById('total-vivo');
            l.innerHTML = ""; let s = 0;
            route.forEach(i => { s += i.q; l.innerHTML += `<div class="item-row"><span>${i.c} (${i.q})</span><button onclick="delItem(${i.id})" style="background:none; border:none; color:var(--danger)">üóëÔ∏è</button></div>`; });
            t.innerText = s; document.getElementById('area-envio').style.display = route.length > 0 ? 'block' : 'none';
        }

        function delItem(id) { route = route.filter(i => i.id !== id); renderRoute(); }
        function cancelar() { route = []; editId = null; document.getElementById('edit-indicator').style.display="none"; renderRoute(); }

        function procesar(wa) {
            const ch = document.getElementById('cho').value, pl = document.getElementById('pla').value, ax = document.getElementById('aux').value;
            if(!ch || !pl || !ax) return alert("Complete Chofer, Placa y Auxiliar");
            const reg = { id: editId || Date.now(), fecha: new Date().toISOString(), operario: user, chofer: ch, placa: pl, auxiliar: ax, destinos: [...route], total: route.reduce((a,b)=>a+b.q, 0) };
            if(editId) db = db.map(r => r.id === editId ? reg : r); else db.push(reg);
            localStorage.setItem('twins_v29', JSON.stringify(db));
            if(wa) {
                let msg = `*REPORTE TWINS*\nüë§ Op: ${user}\nüöö Ch: ${ch}\nüöõ Pl: ${pl}\nüèÉ Aux: ${ax}\n----------------\n`;
                route.forEach(i => msg += `‚Ä¢ ${i.c}: ${i.q} CJ\n`);
                msg += `----------------\nüì¶ TOTAL: ${reg.total} CAJAS`;
                window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`);
            }
            cancelar(); alert("Guardado");
        }

        function showHistory() { renderHistory(); switchPage('p2', 'p3'); }

        function renderHistory() {
            const list = document.getElementById('history-list'), m = parseInt(document.getElementById('filter-month').value);
            let tR = 0, tC = 0; list.innerHTML = "";
            db.slice().reverse().forEach(r => {
                const d = new Date(r.fecha);
                if(d.getMonth() === m) {
                    if(r.chofer === "ROMARIO") tR += r.total;
                    if(r.chofer === "CESAR") tC += r.total;
                    list.innerHTML += `<div class="card">
                        <small style="color:var(--primary)">${d.toLocaleDateString()} - ${r.auxiliar}</small><br>
                        <b>${r.chofer}</b> (${r.total} CJ)<br>
                        <button class="btn btn-outline" style="font-size:12px; padding:5px;" onclick="editH(${r.id})">‚úèÔ∏è EDITAR</button>
                    </div>`;
                }
            });
            document.getElementById('st-rom').innerText = tR; document.getElementById('st-ces').innerText = tC;
        }

        function editH(id) {
            const r = db.find(x => x.id === id);
            editId = id; route = [...r.destinos];
            document.getElementById('cho').value = r.chofer;
            document.getElementById('pla').value = r.placa;
            document.getElementById('aux').value = r.auxiliar;
            document.getElementById('edit-indicator').style.display = "block";
            renderRoute(); switchPage('p3', 'p2');
        }
    </script>
</body>
</html>
